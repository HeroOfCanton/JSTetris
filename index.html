<!DOCTYPE HTML>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <title>Tetris</title>

    <!-- THIS FIRST -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <script src="jquery-1.11.2.min.js"></script> <!-- 1 - JQUERY -->
    <script src="pixi.js"></script>
    <script src="tetris.js"></script>

    <script type="text/javascript">
	      $(document).on("click", "#highscore", function(e){
	        $("#scoreboard").load("highscore_controller.php");
	      });
    </script>

  </head>
	<body style="padding-top: 70px;">

		<div class="container">
	    <div class="jumbotron">
        <div align="center">  
          <h2>TETRIS in Pixi.js</h2>
        </div>
      </div>
    </div>

    <div class="container">
    	<div class="row">
    		<div class="col-sm-8">
					<div id="tetris" align="center">
						
					</div>
				</div> <!--col-sm-4-->
				<div class="col-sm-2">
					<div id="scoreboard">
							
					</div><!--id-->
				</div><!--col-sm-4-->
				<div class = "col-sm-2">
					<button class="btn btn-primary" type="button" id="highscore">Show High Scores</button>
				</div>
			</div> <!--row-->
		</div> <!--container-->


    <script>
		$(function tetrisController(){
		    var GRID_WIDTH = 10;
		    var GRID_HEIGHT = 20;
		    var SPRITE_WIDTH = 24;
		  
		    var SCOREBOARD_WIDTH = SPRITE_WIDTH * 5;

		    var CANVAS_WIDTH = GRID_WIDTH * SPRITE_WIDTH;
		    var CANVAS_HEIGHT = GRID_HEIGHT * SPRITE_WIDTH;
		    var stage = new PIXI.Container();
		    var renderer = PIXI.autoDetectRenderer(CANVAS_WIDTH, CANVAS_HEIGHT);
		    document.getElementById("tetris").appendChild(renderer.view);     // add the renderer view element to the DOM

		    var orientation = 0;
		    var shapes = ['t', 'l', 'j', 'z', 's', 'i', 'q'];

		    var shape = 'i';

		    var grid = new Array(GRID_HEIGHT);
		    for (var i = 0; i < GRID_HEIGHT; i++) {
		        grid[i] = new Array(GRID_WIDTH);
		    }

		    var piece = new Array();

		    //var grid = new Grid(GRID_WIDTH, GRID_HEIGHT, SPRITE_WIDTH);
		    var block = addRectangle(0, 0, 0xff0000);
		    stage.addChild(block);

            
		    var block2 = addRectangle(0, 10, 0xff0000);
		    stage.addChild(block2);

              
		    newPiece(0xff0000, shape);
		    for (var i = 0; i < piece.length; ++i)
		        stage.addChild(piece[i]);
                

		  /**
		   * TEXT / SCOREBOARD
		   */

            /*
		  var scoreboardBackground = new PIXI.Graphics();
		  scoreboardBackground.beginFill(0x7E7215);
		  scoreboardBackground.drawRect(0, 0, SCOREBOARD_WIDTH, CANVAS_HEIGHT);
		  scoreboardBackground.endFill();
		  stage.addChild(scoreboardBackground);

		  var levelText = new PIXI.Text("Level\n0", {font:"26px Monospace", fill: "black"});
		  stage.addChild(levelText);

		  var clearedLinesText = new PIXI.Text("Clear\n0", {font:"26px Monospace", fill: "black"});
		  clearedLinesText.position.y = Math.floor((CANVAS_HEIGHT - 56) / 3);
		  stage.addChild(clearedLinesText);

		  var nextText = new PIXI.Text("Next", {font:"26px Monospace", fill: "black"});
		  nextText.position.y = Math.floor((CANVAS_HEIGHT - 56) * 2 / 3);
		  stage.addChild(nextText);

		  var scoreText = new PIXI.Text("Score\n0", {font:"26px Monospace", fill: "black"});
		  scoreText.position.y = CANVAS_HEIGHT - 56;
		  stage.addChild(scoreText);
          */
	    

	    renderer.render(stage);

	    requestAnimationFrame(animate);
        
	    function addRectangle(x, y, color) {
	        var rectangle = new PIXI.Graphics();
	        rectangle.beginFill(color);
	        rectangle.lineStyle(2, 0x000000);
	        rectangle.position.set(x * SPRITE_WIDTH, y * SPRITE_WIDTH);
	        rectangle.drawRect(0, 0, SPRITE_WIDTH, SPRITE_WIDTH);
	        grid[y][x] = rectangle;
	        return rectangle;
	    }

            
	    function newPiece(color, shape) {
	        if (shape === 'z') {
	            piece = [
                    addRectangle(5, 5, color),
                    addRectangle(4, 5, color),
                    addRectangle(4, 6, color),
                    addRectangle(5, 4, color)
	            ];
	        }
	        if (shape === 's') {
	            piece = [
                    addRectangle(4, 5, color),
                    addRectangle(5, 5, color),
                    addRectangle(5, 6, color),
                    addRectangle(4, 4, color)
	            ];
	        }
	        if (shape === 't') {
	            piece = [
                    addRectangle(5, 5, color),
                    addRectangle(4, 5, color),
                    addRectangle(6, 5, color),
                    addRectangle(5, 6, color)
	            ];
	        }
	        if (shape === 'q') {
	            piece = [
                    addRectangle(4, 4, color),
                    addRectangle(4, 5, color),
                    addRectangle(5, 4, color),
                    addRectangle(5, 5, color)
	            ];
	        }
	        if (shape === 'i') {
	            piece = [
                    addRectangle(5, 5, color),
                    addRectangle(5, 3, color),
                    addRectangle(5, 4, color),
                    addRectangle(5, 6, color)
	            ];
	        }
	        orientation = 0;
	    }
            
	    function isEmpty(x, y) {
	        if (typeof grid[y][x] === 'undefined')
	            return true;
	        else
	            return false;
	    }

	    function getX(rectangle) {
	        return rectangle.position.x / SPRITE_WIDTH;
	    }

	    function getY(rectangle) {
	        return rectangle.position.y / SPRITE_WIDTH;
	    }

	    function setX(rectangle, x) {
	        rectangle.position.x = x * SPRITE_WIDTH
	    }

	    function setY(rectangle, y) {
	        rectangle.position.y = y * SPRITE_WIDTH;
	    }
	    function moveRectangle(x1, y1, x2, y2) {
	        grid[y2][x2] = grid[y1][x1];
	        grid[y1][x1] = undefined;
	        grid[y2][x2].position.x = x2 * SPRITE_WIDTH;
	        grid[y2][x2].position.y = y2 * SPRITE_WIDTH;
	    }

	    function rotatePiece() {
	        if (shape === 'q')
	            return;
	        if (shape === 't') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 's') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0])-1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0])+1, getX(piece[0])-1, getY(piece[0]));
	                    moveRectangle(getX(piece[0])+1, getY(piece[0]), getX(piece[0]), getY(piece[0])+1);
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0])+1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]) + 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 'z') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0])+1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0])-1, getX(piece[0])+1, getY(piece[0]));
	                    moveRectangle(getX(piece[0])-1, getY(piece[0]), getX(piece[0]), getY(piece[0])-1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]), getY(piece[0])+1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0])+1, getY(piece[0]), getX(piece[0]), getY(piece[0])+1);
	                    moveRectangle(getX(piece[0]), getY(piece[0])-1, getX(piece[0])+1, getY(piece[0]));
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]) - 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 0;
	                }
	            }
	        }
	    }
	    window.addEventListener("keydown", function (e) {
	        e.preventDefault();
	        if (e.keyCode === 32) { // space bar
	            //circle.position.y = 100;
	        }
	        if (e.keyCode === 37) { // left
	            rotatePiece();
	        }
	        if (e.keyCode === 38) { // up
	            //circle.fillColor = 0xffffff;
	        }
	        if (e.keyCode === 39) { // right
	            //circle.fillColor = 0xffff00;
	        }
	        if (e.keyCode === 40) { // down
	            //circle.fillColor = 0xff00ff;
	        }
	        if (e.keyCode === 90) { // Z
	            //circle.fillColor = 0x00ffff;
	        }
	        if (e.keyCode === 88) { // X
	            //circle.fillColor = 0x0000ff;
	        }
	        //circle.drawCircle(circle.position.x, circle.position.y, circle.height/2);
	        renderer.render(stage);
	    });

	    var blockX = 0;
	    var blockY = 0;
	    function animate() {
	        setTimeout(animate, 1000);
	        if (isEmpty(blockX, blockY + 1)) {
	            moveRectangle(blockX, blockY, blockX, blockY + 1);
	            blockY += 1;
	        }
	        
	        

	    	renderer.render(stage);     // render the stage
			}
		});
		//tetrisController();
		
		//
		// this function is called before every browser/canvas repaint
		// approximately 30 or 60 times per second
		//
		// by putting requestAnimFrame(animate) in here, we cause an animation loop
		//
		
		/*
		$(function ()
		{

		//var loader = new PIXI.AssetLoader(["button.png","button_over.png","button_down.png"]);
		//loader.onComplete = start_button_example;
		//loader.load();

		var loader = PIXI.loader;
		//loader.add("button.png", "button.png");
		//loader.add("button_over.png", "button_over.png");
		//loader.add("button_down","button_down.png");
		loader.once('complete', tetrisController);
		loader.load();

		});*/

    </script>
        <p id="test"></p>
	</body>
</html>
