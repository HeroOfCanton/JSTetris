<!DOCTYPE HTML>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <title>Tetris</title>

    <!-- THIS FIRST -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <script src="jquery-1.11.2.min.js"></script> <!-- 1 - JQUERY -->
    <script src="pixi.js"></script>
    <script src="tetris.js"></script>

    <script type="text/javascript">
      	$(document).on("click", "#highscore", function(e){
        	$("#scoreboard").load("highscore_controller.php");
      	});

      	$(document).on("click", "#startgame", function(e){
      		$("#tetris").html("");
        	$("#tetris").load(tetrisController());
      	});
    </script>

  </head>
	<body style="padding-top: 70px;">

	<div class="container">
    	<div class="jumbotron">
    		<div align="center">  
      			<h2>TETRIS in Pixi.js</h2>
    		</div>
  		</div>
	</div>

    <div class="container">
    	<div class="row">
    		<div class="col-sm-8 text-center">
    			<button class="btn btn-primary" type="button" id="startgame">Start New Game</button>
				<div id="tetris" style="padding-top: 10px;">
				</div>
			</div> <!--col-sm-8-->
				
			<div class = "col-sm-4 text-center">
				<button class="btn btn-primary" type="button" id="highscore">Show High Scores</button>
				<div id="scoreboard">
				</div>
			</div> <!--col-sm-4-->
		</div> <!--row-->
	</div> <!--container-->


    <script>
		function tetrisController(){
	    var GRID_WIDTH = 10;
	    var GRID_HEIGHT = 20;
	    var SPRITE_WIDTH = 24;
	  
	    var SCOREBOARD_WIDTH = SPRITE_WIDTH * 5;

	    var CANVAS_WIDTH = GRID_WIDTH * SPRITE_WIDTH;
	    var CANVAS_HEIGHT = GRID_HEIGHT * SPRITE_WIDTH;
	    var stage = new PIXI.Container();
	    var renderer = PIXI.autoDetectRenderer(CANVAS_WIDTH, CANVAS_HEIGHT);
	    document.getElementById("tetris").appendChild(renderer.view);     // add the renderer view element to the DOM

	    var orientation = 0;
	    var shapes = ['t', 'l', 'j', 'z', 's', 'i', 'q'];
	    var score = 0;
	    var scoreString = new PIXI.Text(score.toString(), { fill: 0xffffff });
	    stage.addChild(scoreString);
	    scoreString.x = 10;
	    scoreString.y = 10;

	    var grid = new Array(GRID_HEIGHT);
	    for (var i = 0; i < GRID_HEIGHT; i++) {
	        grid[i] = new Array(GRID_WIDTH);
	    }

	    var piece = new Array();
	    newPiece(0xff0000);
	    renderer.render(stage);
	    requestAnimationFrame(animate);

	    function addRectangle(x, y, color) {
	        var rectangle = new PIXI.Graphics();
	        rectangle.beginFill(color);
	        rectangle.lineStyle(2, 0x000000);
	        rectangle.position.set(x * SPRITE_WIDTH, y * SPRITE_WIDTH);
	        rectangle.drawRect(0, 0, SPRITE_WIDTH, SPRITE_WIDTH);
	        grid[y][x] = rectangle;
	        stage.addChild(rectangle);
	        return rectangle;
	    }
	    /**
          * Returns a random number between min (inclusive) and max (exclusive)
          */
	    function random(min, max) {
	        return Math.round(Math.random() * (max - min) + min);
	    }
            
	    function newPiece(color) {
	        shape = shapes[random(0, 7)];
	        if (shape === 'z') {
	        	if(!isEmpty(5, 1) || !isEmpty(4, 1) || !isEmpty(4, 2) || !isEmpty(5, 0)) {
		            	endgame();
		        }
		        else {
		            piece = [  
		                addRectangle(5, 1, 0xff0000),
		                addRectangle(4, 1, 0xff0000),
		                addRectangle(4, 2, 0xff0000),
		                addRectangle(5, 0, 0xff0000)
			        ];
		        }
	        }
	        else if (shape === 's') {
	        	if(!isEmpty(4, 1) || !isEmpty(5, 1) || !isEmpty(5, 2) || !isEmpty(4, 0)) {
		            	endgame();
		        }
		        else {
		            piece = [
	                    addRectangle(4, 1, 0x00ff00),
	                    addRectangle(5, 1, 0x00ff00),
	                    addRectangle(5, 2, 0x00ff00),
	                    addRectangle(4, 0, 0x00ff00)
		            ];
	            }
	        }
	        else if (shape === 't') {
	        	if(!isEmpty(5, 0) || !isEmpty(4, 0) || !isEmpty(6, 0) || !isEmpty(5, 1)) {
		            	endgame();
		        }
		        else {
		            piece = [
	                    addRectangle(5, 0, 0x0000ff),
	                    addRectangle(4, 0, 0x0000ff),
	                    addRectangle(6, 0, 0x0000ff),
	                    addRectangle(5, 1, 0x0000ff)
		            ];
	          	}
	        }
	        else if (shape === 'q') {
	        	if(!isEmpty(4, 0) || !isEmpty(4, 1) || !isEmpty(5, 0) || !isEmpty(5, 1)) {
		            	endgame();
		        }
		        else {
		            piece = [
	                    addRectangle(4, 0, 0x00ffff),
	                    addRectangle(4, 1, 0x00ffff),
	                    addRectangle(5, 0, 0x00ffff),
	                    addRectangle(5, 1, 0x00ffff)
		            ];
	          	}
	        }
	        else if (shape === 'i') {
	        	if(!isEmpty(5, 2) || !isEmpty(5, 0) || !isEmpty(5, 1) || !isEmpty(5, 3)) {
		            	endgame();
		        }
		        else {
		            piece = [
	                    addRectangle(5, 2, 0xff00ff),
	                    addRectangle(5, 0, 0xff00ff),
	                    addRectangle(5, 1, 0xff00ff),
	                    addRectangle(5, 3, 0xff00ff)
		            ];
	          	}
	        }
	        else if (shape === 'j') {
	        	if(!isEmpty(5, 1) || !isEmpty(6, 0) || !isEmpty(5, 0) || !isEmpty(5, 2)) {
		            	endgame();
		        }
		        else {
		            piece = [
	                    addRectangle(5, 1, 0xffff00),
	                    addRectangle(6, 0, 0xffff00),
	                    addRectangle(5, 0, 0xffff00),
	                    addRectangle(5, 2, 0xffff00)
		            ];
	          	}
	        }
	        else if (shape === 'l') {
	        	if(!isEmpty(5, 1) || !isEmpty(4, 0) || !isEmpty(5, 0) || !isEmpty(5, 2)) {
		            	endgame();
		            }
		        else {
		            piece = [
	                    addRectangle(5, 1, 0xffffff),
	                    addRectangle(4, 0, 0xffffff),
	                    addRectangle(5, 0, 0xffffff),
	                    addRectangle(5, 2, 0xffffff)
		            ];
	          	}
	        }
	        else {
	        	if(!isEmpty(5, 0) || !isEmpty(4, 0) || !isEmpty(6, 0) || !isEmpty(5, 1)) {
		            	endgame();
		        }
	        	else {
	        	    shape = 't';
		            piece = [
	                    addRectangle(5, 0, 0x0000ff),
	                    addRectangle(4, 0, 0x0000ff),
	                    addRectangle(6, 0, 0x0000ff),
	                    addRectangle(5, 1, 0x0000ff)
		            ];
	          	}
	        }
	        orientation = 0;
	    }
            
	    function isEmpty(x, y) {
	        if (x < 0 || y < 0 || x >= GRID_WIDTH || y >= GRID_HEIGHT)
	            return false;
	        if (typeof grid[y][x] === 'undefined')
	            return true;
	        else
	            return false;
	    }

	    function getX(rectangle) {
	        return rectangle.position.x / SPRITE_WIDTH;
	    }

	    function getY(rectangle) {
	        return rectangle.position.y / SPRITE_WIDTH;
	    }

	    function setX(rectangle, x) {
	        rectangle.position.x = x * SPRITE_WIDTH
	    }

	    function setY(rectangle, y) {
	        rectangle.position.y = y * SPRITE_WIDTH;
	    }
	    function moveRectangle(x1, y1, x2, y2) {
	        grid[y2][x2] = grid[y1][x1];
	        grid[y1][x1] = undefined;
	        grid[y2][x2].position.x = x2 * SPRITE_WIDTH;
	        grid[y2][x2].position.y = y2 * SPRITE_WIDTH;
	    }

	    function rotatePiece() {
	        if (shape === 'q')
	            return;
	        if (shape === 't') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 's') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]) - 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]) + 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 'z') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]) + 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) - 1) && isEmpty(getX(piece[0]), getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]));
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]) - 1, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]) - 1, getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]));
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 'i') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 2, getY(piece[0]))) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 2, getX(piece[0]) - 2, getY(piece[0]));
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 2)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) - 2, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 2);
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 'j') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0])) && isEmpty(getX(piece[0]) +1, getY(piece[0])+1)) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0])+1, getY(piece[0]) - 1, getX(piece[0]) +1, getY(piece[0])+1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1) && isEmpty(getX(piece[0])-1, getY(piece[0]) +1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0])+1, getX(piece[0])-1, getY(piece[0]) +1);
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1) && isEmpty(getX(piece[0]) + 1, getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    orientation = 0;
	                }
	            }
	        }
	        if (shape === 'l') {
	            if (orientation === 0) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0])) && isEmpty(getX(piece[0]) + 1, getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) - 1);
	                    orientation = 1;
	                }
	            }
	            else if (orientation === 1) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1) && isEmpty(getX(piece[0]) + 1, getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) - 1, getX(piece[0]) + 1, getY(piece[0]) + 1);
	                    orientation = 2;
	                }
	            }
	            else if (orientation === 2) {
	                if (isEmpty(getX(piece[0]) + 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0])) && isEmpty(getX(piece[0]) - 1, getY(piece[0]) + 1)) {
	                    moveRectangle(getX(piece[0]), getY(piece[0]) + 1, getX(piece[0]) + 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]), getY(piece[0]) - 1, getX(piece[0]) - 1, getY(piece[0]));
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) + 1);
	                    orientation = 3;
	                }
	            }
	            else if (orientation === 3) {
	                if (isEmpty(getX(piece[0]), getY(piece[0]) + 1) && isEmpty(getX(piece[0]), getY(piece[0]) - 1) && isEmpty(getX(piece[0]) - 1, getY(piece[0]) - 1)) {
	                    moveRectangle(getX(piece[0]) + 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) + 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]), getX(piece[0]), getY(piece[0]) - 1);
	                    moveRectangle(getX(piece[0]) - 1, getY(piece[0]) + 1, getX(piece[0]) - 1, getY(piece[0]) - 1);
	                    orientation = 0;
	                }
	            }
	        }
	    }

	    function compareNumbers(a, b) {
	        return a - b;
	    }
	    function compareNumbersReverse(a, b) {
	        return b - a;
	    }
	    function moveLeft() {
	        var coords = {};
	        for (var i = 0; i < piece.length; ++i) {
	            if (coords.hasOwnProperty(getY(piece[i]).toString())) {
	                coords[getY(piece[i]).toString()].push(getX(piece[i]));
	            }
	            else {
	                coords[getY(piece[i]).toString()] = new Array();
	                coords[getY(piece[i]).toString()].push(getX(piece[i]))
	            }
	        }
	        var empty = true;
	        for (var key in coords) {
	            if (coords.hasOwnProperty(key)) {
	                coords[key].sort(compareNumbers);
	                empty = isEmpty(coords[key][0] - 1, key);
	                if (!empty)
	                    return;
	            }
	        }
	        if (empty) {
	            for (var y in coords) {
	                if (coords.hasOwnProperty(y)) {
	                    for (var x in coords[y]) {
	                        moveRectangle(coords[y][x], y, coords[y][x] - 1, y);
	                    }
	                }
	            }
	        }
	    }
	    function moveRight() {
	        var coords = {};
	        for (var i = 0; i < piece.length; ++i) {
	            if (coords.hasOwnProperty(getY(piece[i]).toString())) {
	                coords[getY(piece[i]).toString()].push(getX(piece[i]));
	            }
	            else {
	                coords[getY(piece[i]).toString()] = new Array();
	                coords[getY(piece[i]).toString()].push(getX(piece[i]))
	            }
	        }
	        var empty = true;
	        for (var key in coords) {
	            if (coords.hasOwnProperty(key)) {
	                coords[key].sort(compareNumbersReverse);
	                empty = isEmpty(coords[key][0] + 1, key);
	                if (!empty)
	                    return;
	            }
	        }
	        if (empty) {
	            for (var y in coords) {
	                if (coords.hasOwnProperty(y)) {
	                    for (var x in coords[y]) {
	                        moveRectangle(coords[y][x], y, coords[y][x] + 1, y);
	                    }
	                }
	            }
	        }
	    }

	    function drop() {
	    	var coords = {};
	        for (var i = 0; i < piece.length; ++i) {
	            if (coords.hasOwnProperty(getX(piece[i]).toString())) {
	                coords[getX(piece[i]).toString()].push(getY(piece[i]));
	            }
	            else {
	                coords[getX(piece[i]).toString()] = new Array();
	                coords[getX(piece[i]).toString()].push(getY(piece[i]))
	            }
	        }
	        var empty = true;
	        for (var key in coords) {
	            if (coords.hasOwnProperty(key)) {
	                coords[key].sort(compareNumbersReverse);
	                empty = isEmpty(key, coords[key][0] + 1);
	                if (!empty)
	                    return false;
	            }
	        }
	        if (empty) {
	            for (var x in coords) {
	                if (coords.hasOwnProperty(x)) {
	                    for (var y in coords[x]) {
	                        moveRectangle(x, coords[x][y], x, coords[x][y] + 1);
	                    }
	                }
	            }
	        }
	        return true;
	    }

	    function checkClear() {
	        var set = new Set();
	        for (var i = 0; i < piece.length; ++i) {
	            set.add(getY(piece[i]));
	        }
	        var clearedSet = new Set();
	        for (let y of set) {
	            var clear = true;
	            for (var i = 0; i < grid[y].length; ++i) {
	                if (typeof grid[y][i] === 'undefined') {
	                    clear = false;
	                }
	            }
	            if (clear)
	                clearedSet.add(y);
	        }
	        var clearedArray = new Array();
	        for (let y of clearedSet) {
	            for (var i = 0; i < grid[y].length; ++i) {
	                stage.removeChild(grid[y][i]);
	                grid[y][i] = undefined;
	            }
	            clearedArray.push(y);
	        }
	        score += 100 * clearedArray.length;
	        scoreString.text = score.toString();
	        clearedArray.sort(compareNumbersReverse);
	        for (var i = clearedArray[0]; i >= 0; --i) {
	            for (var j = 0; j < grid[i].length; ++j) {
	                if (!isEmpty(j, i)) {
	                    moveRectangle(getX(grid[i][j]), getY(grid[i][j]), getX(grid[i][j]), getY(grid[i][j]) + clearedArray.length);
	                }
	            }
	        }
	    }

	    window.addEventListener("keydown", function (e) {
	        e.preventDefault();
	        if (e.keyCode === 32) { // space bar
	            rotatePiece();
	        }
	        if (e.keyCode === 37) { // left
	            moveLeft();
	        }
	        if (e.keyCode === 38) { // up
	            rotatePiece();
	        }
	        if (e.keyCode === 39) { // right
	            moveRight();
	        }
	        if (e.keyCode === 40) { // down
	            drop();
	        }
	        renderer.render(stage);
	    });

	    function animate() {
	        var myTimer = setTimeout(animate, 1000);
	        if (!drop()) {
	            clearTimeout(myTimer);
	            checkClear();
	        	newPiece(0xff0000);
	        	myTimer = setTimeout(animate, 1000);
	      	} 
	    	renderer.render(stage);     // render the stage
		};

		function endgame() {
			alert("End Game");
		}

	};

    </script>
        <p id="test"></p>
	</body>
</html>
